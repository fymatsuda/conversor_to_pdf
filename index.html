<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversor para PDF</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1 {
      color: #333;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      max-width: 1000px;
    }

    .box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
      width: 250px;
    }

    .box h2 {
      font-size: 18px;
      margin-bottom: 15px;
    }

    input[type="file"] {
      margin: 10px 0;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }

    .btn-blue {
      background-color: #007bff;
    }

    .btn-green {
      background-color: #28a745;
    }

    .btn-red {
      background-color: #dc3545;
    }

    /* Área de status */
    .status {
      margin-top: 20px;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      transition: color 0.3s ease;
    }

    .status.success {
      color: #28a745; /* Verde */
    }

    .status.error {
      color: #dc3545; /* Vermelho */
    }

    .status.info {
      color: #007bff; /* Azul */
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.38.2/docxtemplater.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h1>Conversor para PDF</h1>
  <div class="container">
    <!-- IMAGENS → PDF -->
    <div class="box">
      <h2>Imagens → PDF</h2>
      <button class="btn-blue" onclick="selectImages()">Selecionar Imagens</button>
    </div>

    <!-- DOCX → PDF (Google Drive) -->
    <div class="box">
      <h2>DOCX → PDF (Drive)</h2>
      <input type="file" id="docxFile" accept=".docx">
      <button class="btn-green" onclick="convertDocx()">Converter</button>
    </div>

    <!-- HTML → PDF -->
    <div class="box">
      <h2>HTML → PDF</h2>
      <button class="btn-red" onclick="selectHtml()">Selecionar HTML</button>
    </div>
  </div>

  <div id="status" class="status"></div>

  <script>
    let accessToken = null;
    let accessTokenExp = null;
    let tokenClient = null;
    let logoutTimer = null;

    /* Atualiza mensagens com cores */
    function setStatus(message, type = "info") {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }

    /* Inicializa Google API */
    function initGoogleAPI() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: "955109384859-ctdif5e4tkmgts5f65uuk80o875lp4s5.apps.googleusercontent.com",
        scope: "https://www.googleapis.com/auth/drive.file",
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            accessTokenExp = Date.now() + (resp.expires_in - 60) * 1000;
            iniciarLogoutTimer();
          }
        }
      });
    }

    /* Logout automático após 5 min */
    function iniciarLogoutTimer() {
      if (logoutTimer) clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        accessToken = null;
        accessTokenExp = null;
        setStatus("Sessão expirada. Faça login novamente.", "error");
      }, 5 * 60 * 1000);
    }

    async function ensureToken() {
      const stillValid = accessToken && Date.now() < accessTokenExp;
      if (stillValid) return accessToken;

      return new Promise((resolve, reject) => {
        tokenClient.callback = (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            accessTokenExp = Date.now() + (resp.expires_in - 60) * 1000;
            iniciarLogoutTimer();
            resolve(accessToken);
          } else {
            reject(new Error("Falha ao obter token."));
          }
        };
        tokenClient.requestAccessToken({ prompt: '' });
      });
    }

    /* === Imagens → PDF === */
    async function selectImages() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.onchange = () => convertImagesToPDF(input.files);
      input.click();
    }

    async function convertImagesToPDF(files) {
      if (!files.length) return;
      setStatus("Convertendo imagens para PDF...", "info");

      const { PDFDocument } = PDFLib;
      const pdfDoc = await PDFDocument.create();

      for (let file of files) {
        const imgBytes = await file.arrayBuffer();
        const img = await pdfDoc.embedJpg(imgBytes).catch(() => pdfDoc.embedPng(imgBytes));
        const page = pdfDoc.addPage([img.width, img.height]);
        page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
      }

      const pdfBytes = await pdfDoc.save();
      downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), 'imagens.pdf');
      setStatus("Pronto! PDF baixado e arquivo temporário removido.", "success");
    }

    /* === DOCX → PDF (Google Drive) === */
    async function convertDocx() {
      const fileInput = document.getElementById('docxFile');
      if (!fileInput.files.length) {
        setStatus("Selecione um arquivo DOCX primeiro.", "error");
        return;
      }

      try {
        setStatus("Convertendo DOCX para PDF via Google Drive...", "info");
        const token = await ensureToken();
        const file = fileInput.files[0];

        const formData = new FormData();
        formData.append('file', file);
        formData.append('mimeType', 'application/pdf');

        const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
          method: 'POST',
          headers: { Authorization: `Bearer ${token}` },
          body: formData
        });

        if (!uploadResponse.ok) throw new Error('Falha no upload para o Google Drive.');

        const uploadData = await uploadResponse.json();

        // Exporta para PDF
        const exportResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${uploadData.id}/export?mimeType=application/pdf`, {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!exportResponse.ok) throw new Error('Falha na exportação para PDF.');

        const pdfBlob = await exportResponse.blob();
        downloadBlob(pdfBlob, `${file.name.replace('.docx', '')}.pdf`);

        // Remove arquivo temporário do Drive
        await fetch(`https://www.googleapis.com/drive/v3/files/${uploadData.id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${token}` }
        });

        setStatus("Pronto! PDF baixado e arquivo temporário removido.", "success");
      } catch (error) {
        console.error(error);
        setStatus("Erro ao converter DOCX: " + error.message, "error");
      }
    }

    /* === HTML → PDF === */
    async function selectHtml() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'text/html';
      input.onchange = () => convertHtmlToPDF(input.files[0]);
      input.click();
    }

    async function convertHtmlToPDF(file) {
      if (!file) return;
      setStatus("Convertendo HTML para PDF...", "info");

      const reader = new FileReader();
      reader.onload = async (e) => {
        const htmlContent = e.target.result;
        const { PDFDocument } = PDFLib;
        const pdfDoc = await PDFDocument.create();
        const page = pdfDoc.addPage([595, 842]); // A4
        page.drawText(htmlContent.substring(0, 1000)); // Simplificado
        const pdfBytes = await pdfDoc.save();
        downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), file.name.replace('.html', '.pdf'));
        setStatus("Pronto! PDF baixado e arquivo temporário removido.", "success");
      };
      reader.readAsText(file);
    }

    /* Download genérico */
    function downloadBlob(blob, filename) {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    window.onload = initGoogleAPI;
  </script>
</body>
</html>
