<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversor DOCX → PDF</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>Converter DOCX para PDF</h2>

  <!-- Input para escolher o DOCX -->
  <input type="file" id="docx-input" accept=".docx" />

  <!-- Botão visível que dispara o fluxo -->
  <button id="convert-btn">Converter</button>

  <p id="status"></p>

<script>
  const CLIENT_ID = "955109384859-ctdif5e4tkmgts5f65uuk80o875lp4s5.apps.googleusercontent.com";
  const SCOPES = "https://www.googleapis.com/auth/drive.file";

  let tokenClient;
  let accessToken = null;
  let selectedFile = null;

  const statusBox = document.getElementById('status');

  function setStatus(msg) {
    statusBox.textContent = msg;
  }

  window.onload = () => {
    // Inicializa tokenClient
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      prompt: '',
      callback: (resp) => {}
    });

    // Quando seleciona um arquivo, apenas armazena
    document.getElementById('docx-input').addEventListener('change', (e) => {
      selectedFile = e.target.files[0];
      if (selectedFile) {
        setStatus("Arquivo selecionado: " + selectedFile.name);
      }
    });

    // Quando clica em "Converter", dispara login do Google
    document.getElementById('convert-btn').addEventListener('click', () => {
      if (!selectedFile) {
        alert("Selecione um arquivo DOCX primeiro!");
        return;
      }

      setStatus("Abrindo login do Google...");
      tokenClient.callback = async (resp) => {
        if (resp.error) {
          setStatus("Erro no login: " + resp.error);
          return;
        }
        accessToken = resp.access_token;
        setStatus("Login OK! Agora converteremos o arquivo...");
        
        try {
          const docId = await uploadAndConvertToGoogleDoc(selectedFile);
          const pdfBlob = await exportGoogleDocToPdf(docId);
          downloadBlob(pdfBlob, selectedFile.name.replace(/\.docx$/i, ".pdf"));
          await deleteTempFile(docId);
          setStatus("Conversão concluída! PDF baixado.");
        } catch (err) {
          console.error(err);
          setStatus("Erro durante conversão: " + err.message);
        }
      };

      // IMPORTANTE: Chamada direta no clique (não assíncrona)
      tokenClient.requestAccessToken({ prompt: 'consent' });
    });
  };

  // ======= Funções de integração com Google Drive =======
  async function uploadAndConvertToGoogleDoc(file) {
    const metadata = {
      name: file.name.replace(/\.docx$/i, ''),
      mimeType: 'application/vnd.google-apps.document'
    };

    const boundary = '-------314159265358979323846';
    const delimiter = `\r\n--${boundary}\r\n`;
    const closeDelim = `\r\n--${boundary}--`;

    const metaPart = 'Content-Type: application/json; charset=UTF-8\r\n\r\n' + JSON.stringify(metadata);
    const mediaPartHeader = `Content-Type: ${file.type || 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'}\r\n\r\n`;

    const fileBuffer = await file.arrayBuffer();
    const body = new Blob([delimiter, metaPart, delimiter, mediaPartHeader, new Uint8Array(fileBuffer), closeDelim], {
      type: `multipart/related; boundary=${boundary}`
    });

    const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: { Authorization: `Bearer ${accessToken}` },
      body
    });

    if (!resp.ok) throw new Error('Erro no upload/conversão');
    const json = await resp.json();
    return json.id;
  }

  async function exportGoogleDocToPdf(fileId) {
    const url = `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=application/pdf`;
    const resp = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
    if (!resp.ok) throw new Error('Erro ao exportar PDF');
    return await resp.blob();
  }

  async function deleteTempFile(fileId) {
    await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${accessToken}` }
    });
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
