<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conversor para PDF</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsPDF (imagens/txt) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2pdf (HTML renderizado) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Cabe√ßalho -->
  <header class="max-w-5xl mx-auto px-6 py-8 text-center">
    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Conversor para PDF</h1>
    <p class="mt-2 text-gray-500">Imagens, HTML e TXT 100% offline ‚Ä¢ DOCX com convers√£o fiel via Google Drive</p>
  </header>

  <main class="max-w-5xl mx-auto px-6 pb-16 grid gap-6 sm:grid-cols-2 lg:grid-cols-3">

    <!-- Imagens ‚Üí PDF -->
    <section class="bg-white shadow rounded-2xl p-6 flex flex-col">
      <div class="text-4xl mb-3">üñºÔ∏è</div>
      <h2 class="text-lg font-semibold">Imagens ‚Üí PDF</h2>
      <p class="text-sm text-gray-500 mb-4">PNG, JPG, WEBP (m√∫ltiplos)</p>
      <input type="file" id="imgInput" accept="image/png,image/jpeg,image/webp" multiple class="hidden" />
      <button id="btnImgs" class="w-full mt-auto bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
        Selecionar e Converter
      </button>
    </section>

    <!-- HTML ‚Üí PDF -->
    <section class="bg-white shadow rounded-2xl p-6 flex flex-col">
      <div class="text-4xl mb-3">üåê</div>
      <h2 class="text-lg font-semibold">HTML ‚Üí PDF</h2>
      <p class="text-sm text-gray-500 mb-4">Mant√©m layout e estilos</p>
      <input type="file" id="htmlInput" accept=".html,.htm" class="hidden" />
      <button id="btnHtml" class="w-full mt-auto bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">
        Selecionar e Converter
      </button>
    </section>

    <!-- TXT ‚Üí PDF -->
    <section class="bg-white shadow rounded-2xl p-6 flex flex-col">
      <div class="text-4xl mb-3">üìÉ</div>
      <h2 class="text-lg font-semibold">TXT ‚Üí PDF</h2>
      <p class="text-sm text-gray-500 mb-4">Texto simples (offline)</p>
      <input type="file" id="txtInput" accept=".txt" class="hidden" />
      <button id="btnTxt" class="w-full mt-auto bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
        Selecionar e Converter
      </button>
    </section>

    <!-- DOCX fiel via Google Drive -->
    <section class="bg-white shadow rounded-2xl p-6 flex flex-col sm:col-span-2 lg:col-span-3">
      <div class="flex items-center gap-3 mb-3">
        <div class="text-4xl">üìÑ</div>
        <div>
          <h2 class="text-lg font-semibold">DOCX ‚Üí PDF (via Google Drive)</h2>
          <p class="text-sm text-gray-500">
            Requer login Google. O arquivo √© enviado temporariamente ao seu Drive, convertido e apagado.
          </p>
        </div>
      </div>

      <div class="bg-gray-50 rounded-xl p-4">
        <input type="file" id="docxInput" accept=".docx" class="block w-full text-sm mb-3" />
        <button id="btnDocxToPdf" class="w-full bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700">
          Converter fiel (Drive)
        </button>
        <p id="authStatus" class="mt-2 text-xs text-gray-500">N√£o conectado</p>
        <p id="docxStatus" class="mt-3 text-sm"></p>
      </div>
    </section>
  </main>

  <footer class="text-center text-xs text-gray-400 pb-10">¬© <span id="year"></span> Conversor para PDF</footer>

  <script>
    document.title = 'Conversor para PDF';
    document.getElementById('year').textContent = new Date().getFullYear();

    const { jsPDF } = window.jspdf;

    // ======== Fun√ß√µes auxiliares ========
    function fileToDataURL(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }
    function loadImage(src) {
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res(img);
        img.onerror = rej;
        img.src = src;
      });
    }
    function setStatus(msg, color = "text-gray-600") {
      const status = document.getElementById('docxStatus');
      status.textContent = msg;
      status.className = `mt-3 text-sm ${color}`;
    }

    // =============== Imagens ‚Üí PDF ===============
    document.getElementById('btnImgs').addEventListener('click', async () => {
      const input = document.getElementById('imgInput');
      input.onchange = async () => {
        if (!input.files.length) return;
        const pdf = new jsPDF();
        for (let i = 0; i < input.files.length; i++) {
          const dataUrl = await fileToDataURL(input.files[i]);
          const img = await loadImage(dataUrl);
          const pageW = pdf.internal.pageSize.getWidth();
          const pageH = pdf.internal.pageSize.getHeight();
          let w = pageW, h = (img.height * w) / img.width;
          if (h > pageH) { h = pageH; w = (img.width * h) / img.height; }
          if (i > 0) pdf.addPage();
          pdf.addImage(img, dataUrl.includes('png') ? 'PNG' : 'JPEG', (pageW - w)/2, (pageH - h)/2, w, h);
        }
        pdf.save('imagens.pdf');
      };
      input.click();
    });

    // =============== HTML ‚Üí PDF ===============
    document.getElementById('btnHtml').addEventListener('click', async () => {
      const input = document.getElementById('htmlInput');
      input.onchange = async () => {
        if (!input.files.length) return;
        const text = await input.files[0].text();
        const container = document.createElement('div');
        container.style.padding = '16px';
        container.innerHTML = text;
        document.body.appendChild(container);
        await html2pdf().from(container).set({
          margin: 10,
          filename: input.files[0].name.replace(/\.[^.]+$/, '') + '.pdf',
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
        document.body.removeChild(container);
      };
      input.click();
    });

    // =============== TXT ‚Üí PDF ===============
    document.getElementById('btnTxt').addEventListener('click', async () => {
      const input = document.getElementById('txtInput');
      input.onchange = async () => {
        if (!input.files.length) return;
        const text = await input.files[0].text();
        const pdf = new jsPDF();
        pdf.setFont('courier', 'normal');
        const lines = pdf.splitTextToSize(text, 180);
        pdf.text(lines, 15, 20);
        pdf.save(input.files[0].name.replace(/\.[^.]+$/, '') + '.pdf');
      };
      input.click();
    });

    // =============== Google Drive + DOCX ===============
    const CLIENT_ID = "SEU_CLIENT_ID.apps.googleusercontent.com";
    const API_KEY   = "SUA_API_KEY";
    const SCOPES    = "https://www.googleapis.com/auth/drive.file";

    let tokenClient;
    let accessToken = null;
    let accessTokenExp = null;
    let gapiReady = false;
    let logoutTimer;

    function iniciarLogoutTimer() {
      clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        accessToken = null;
        accessTokenExp = null;
        document.getElementById('authStatus').textContent = 'Sess√£o expirada. Reconecte-se.';
        document.getElementById('authStatus').classList.add('text-red-600');
      }, 5 * 60 * 1000); // 5 minutos
    }

    function initGoogleAPI() {
      if (window.google && google.accounts && google.accounts.oauth2) {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: () => {}
        });
      }
    }

    async function ensureToken() {
      const stillValid = accessToken && Date.now() < accessTokenExp;
      if (stillValid) return accessToken;

      return new Promise((resolve, reject) => {
        if (!tokenClient) initGoogleAPI();

        tokenClient.callback = (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            accessTokenExp = Date.now() + (resp.expires_in - 60) * 1000;
            iniciarLogoutTimer();
            document.getElementById('authStatus').textContent = 'Conectado ‚úÖ';
            resolve(accessToken);
          } else {
            reject(new Error('Falha ao obter token.'));
          }
        };

        tokenClient.requestAccessToken({ prompt: 'consent' });
      });
    }

    window.addEventListener('load', () => {
      if (window.gapi) {
        gapi.load('client', async () => {
          await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
          });
          gapiReady = true;
        });
      }
      initGoogleAPI();
    });

    // =============== Convers√£o DOCX fiel ===============
    document.getElementById('btnDocxToPdf').addEventListener('click', async () => {
      const status = document.getElementById('docxStatus');
      const input = document.getElementById('docxInput');
      if (!gapiReady) return alert('Google API ainda n√£o inicializada.');
      if (!input.files.length) return alert('Selecione um arquivo DOCX.');

      try {
        const token = await ensureToken();
        setStatus('Enviando para o Drive e convertendo‚Ä¶', "text-gray-600");

        const file = input.files[0];

        // 1) Upload com convers√£o para Google Docs
        const metadata = { name: file.name, mimeType: 'application/vnd.google-apps.document' };
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', file);

        const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token },
          body: form
        });
        if (!uploadRes.ok) throw new Error('Falha no upload');
        const { id } = await uploadRes.json();

        // 2) Exportar como PDF
        const exportRes = await fetch(`https://www.googleapis.com/drive/v3/files/${id}/export?mimeType=application/pdf`, {
          headers: { Authorization: 'Bearer ' + token }
        });
        if (!exportRes.ok) throw new Error('Falha ao exportar PDF');
        const blob = await exportRes.blob();

        // 3) Apagar arquivo tempor√°rio
        await gapi.client.drive.files.delete({ fileId: id });

        // 4) Baixar
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name.replace(/\.docx$/i, '') + '.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus('Pronto! PDF baixado e arquivo tempor√°rio removido.', "text-green-600");
      } catch (e) {
        console.error(e);
        setStatus('Erro na convers√£o. Verifique as credenciais e permiss√µes.', "text-red-600");
      }
    });
  </script>
</body>
</html>
