<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversor DOCX → PDF</title>
  <meta name="description" content="Conversão de DOCX para PDF usando Google Drive/Docs via OAuth2, rodando 100% no navegador." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1220;
      --card: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --brand: #60a5fa;
      --border: #1f2937;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #1f2937 0%, var(--bg) 50%, var(--bg) 100%);
      color: var(--text);
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 32px 16px 80px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:24px; }
    .brand { display:flex; align-items:center; gap:12px; }
    .logo { width: 40px; height: 40px; border-radius: 10px; display:grid; place-items:center; background: linear-gradient(135deg, #3b82f6, #22d3ee); font-weight:800; color:#0b1220; }
    h1 { font-size: 22px; margin: 0; letter-spacing: 0.2px; }
    .desc { color: var(--muted); font-size: 14px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: 16px; padding: 16px; min-height: 200px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .card h2 { font-size: 16px; margin: 0 0 8px; }
    .card p { margin: 0 0 12px; color: var(--muted); font-size:14px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { appearance:none; border:none; border-radius: 10px; padding: 10px 14px; font-weight:600; cursor:pointer; background: #1f2937; color: var(--text); border:1px solid var(--border); transition: transform .05s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: linear-gradient(135deg, #3b82f6, #22d3ee); color:#0b1220; border:none; }
    .btn:disabled { opacity: .6; cursor:not-allowed; }
    .filebox { position: relative; display:inline-block; }
    .filebox input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; }
    .status { margin-top: 10px; font-size:13px; line-height:1.4; white-space:pre-line; }
    .status.ok { color: var(--ok); }
    .status.warn { color: var(--warn); }
    .status.err { color: var(--err); }
    footer { margin-top: 36px; color: var(--muted); font-size: 12px; text-align:center; }
  </style>
  <!-- Google Identity Services for OAuth 2.0 -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">PDF</div>
        <div>
          <h1>Conversor de Arquivos</h1>
          <div class="desc">Sem servidor · roda no navegador · usa seu Google Drive só quando necessário</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- DOCX → PDF -->
      <section class="card">
        <h2>DOCX → PDF</h2>
        <p>Converta documentos do Word para PDF com fidelidade, usando Google Docs. O arquivo é apagado do Drive após a conversão.</p>
        <div class="row">
          <label class="filebox btn primary">
            <input type="file" id="docx-input" accept=".docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
            Selecionar DOCX
          </label>
        </div>
        <div class="status" id="status-docx"></div>
      </section>

      <!-- Espaços futuros -->
      <section class="card" aria-disabled="true">
        <h2>HTML → PDF</h2>
        <p>Em breve</p>
      </section>
      <section class="card" aria-disabled="true">
        <h2>TXT → PDF</h2>
        <p>Em breve</p>
      </section>
    </div>

    <footer>
      <p>Este app usa sua conta Google apenas para criar/ler/deletar arquivos <strong>criados por este app</strong>. Nada é enviado a servidores externos.</p>
    </footer>
  </div>

  <script>
    // ========= CONFIG =========
    const GOOGLE_CLIENT_ID = "955109384859-ctdif5e4tkmgts5f65uuk80o875lp4s5.apps.googleusercontent.com";
    const GOOGLE_OAUTH_SCOPES = "https://www.googleapis.com/auth/drive.file";

    let tokenClient = null;
    let accessToken = null;
    let accessTokenExp = 0;
    let logoutTimer = null;

    const $ = (sel) => document.querySelector(sel);
    const statusBox = $('#status-docx');

    function setStatus(msg, type = 'info') {
      statusBox.classList.remove('ok', 'warn', 'err');
      if (type === 'ok') statusBox.classList.add('ok');
      if (type === 'warn') statusBox.classList.add('warn');
      if (type === 'err') statusBox.classList.add('err');
      statusBox.textContent = msg;
    }

    // Inicializa cliente OAuth assim que a página carrega
    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: GOOGLE_OAUTH_SCOPES,
        prompt: '', // silencioso se já tiver login
        callback: (resp) => {
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            accessTokenExp = Date.now() + (resp.expires_in - 60) * 1000;
            iniciarLogoutTimer();
            processarConversao(); // continua fluxo assim que login obtido
          } else {
            setStatus('Falha no login Google.', 'err');
          }
        },
      });

      $('#docx-input').addEventListener('change', handleFileSelected);
    };

    function iniciarLogoutTimer() {
      if (logoutTimer) clearTimeout(logoutTimer);
      logoutTimer = setTimeout(() => {
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken, () => {
            accessToken = null;
            accessTokenExp = 0;
            setStatus('Sessão expirada após 5 minutos. Faça login novamente na próxima conversão.', 'warn');
          });
        }
      }, 5 * 60 * 1000); // 5 minutos
    }

    async function ensureToken() {
      const stillValid = accessToken && Date.now() < accessTokenExp;
      setStatus('stillValid='+stillValid);
      setStatus('accessToken='+accessToken);
      if (stillValid) return accessToken;
      setStatus('stillValid ='+stillValid);
      return new Promise((resolve, reject) => {
        tokenClient.callback = (resp) => {
          setStatus('resp='+resp);
          setStatus('resp.access_token'+resp.access_token);
          if (resp && resp.access_token) {
            accessToken = resp.access_token;
            accessTokenExp = Date.now() + (resp.expires_in - 60) * 1000;
            setStatus('acessToeknExp='+accessTokenExp);
            iniciarLogoutTimer();
            resolve(accessToken);
          } else {
            reject(new Error('Falha ao obter token.'));
          }
        };
        tokenClient.requestAccessToken({ prompt: '' });
      });
    }

    let selectedFile = null;

    function handleFileSelected(e) {
      selectedFile = e.target.files[0];
      if (!selectedFile) return;
      setStatus('Obtendo permissão do Google…');
      ensureToken().catch(err => setStatus('Erro: ' + err.message, 'err'));
      setStatus('após ensureToken');
    }

    async function processarConversao() {
      if (!selectedFile) return;
      try {
        setStatus('Convertendo… (1/4) Enviando para Google Docs…');
        const docId = await uploadAndConvertToGoogleDoc(selectedFile);

        setStatus('Convertendo… (2/4) Exportando para PDF…');
        const pdfBlob = await exportGoogleDocToPdf(docId);

        setStatus('Finalizando… (3/4) Baixando e limpando…');
        downloadBlob(pdfBlob, replaceExt(selectedFile.name, '.pdf'));
        await safeDeleteFile(docId);

        setStatus('Pronto! PDF baixado e arquivo temporário removido do Drive.', 'ok');
        $('#docx-input').value = '';
        selectedFile = null;
      } catch (err) {
        console.error(err);
        setStatus('Erro: ' + (err.message || String(err)), 'err');
      }
    }

    // ======== Google Drive Helpers ========
    async function uploadAndConvertToGoogleDoc(file) {
      const metadata = {
        name: stripExt(file.name),
        mimeType: 'application/vnd.google-apps.document',
      };
      const boundary = '-------314159265358979323846';
      const delimiter = `\r\n--${boundary}\r\n`;
      const closeDelim = `\r\n--${boundary}--`;

      const metaPart = 'Content-Type: application/json; charset=UTF-8\r\n\r\n' + JSON.stringify(metadata);
      const mediaPartHeader = `Content-Type: ${file.type || 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'}\r\n\r\n`;

      const fileArrayBuffer = await file.arrayBuffer();
      const body = new Blob([delimiter, metaPart, delimiter, mediaPartHeader, new Uint8Array(fileArrayBuffer), closeDelim],
        { type: `multipart/related; boundary=${boundary}` });

      const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: { Authorization: `Bearer ${accessToken}` },
        body,
      });

      if (!resp.ok) throw new Error('Falha no upload: ' + await resp.text());
      const json = await resp.json();
      return json.id;
    }

    async function exportGoogleDocToPdf(fileId) {
      const resp = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=application/pdf`, {
        headers: { Authorization: `Bearer ${accessToken}` },
      });
      if (!resp.ok) throw new Error('Falha ao exportar PDF: ' + await resp.text());
      return await resp.blob();
    }

    async function safeDeleteFile(fileId) {
      try {
        await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${accessToken}` },
        });
      } catch (e) {
        console.warn('Erro ao deletar arquivo temporário:', e);
      }
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ======== Utils ========
    function stripExt(name) {
      const i = name.lastIndexOf('.');
      return i > 0 ? name.slice(0, i) : name;
    }
    function replaceExt(name, newExt) {
      return stripExt(name) + newExt;
    }
  </script>
</body>
</html>
